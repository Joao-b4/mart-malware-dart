import 'dart:ffi';
import 'dart:io';
import 'dart:async';
import 'dart:typed_data';
import 'package:client/util/module_selector.dart';
import 'package:client/util/manipulate_data.dart';

Socket socket;
ModuleSelector moduleSelector = new ModuleSelector();

void connect(){
  Socket.connect("localhost", 6661).then((Socket sock) {
   socket = sock;
   socket.listen(_dataHandler, 
      onError: _errorHandler, 
      onDone: _successfulHandler, 
      cancelOnError: false);
   }).catchError((dynamic e) {
      print("Unable to connect: ${e.toString()}");
   }).then((value){
      socket.write(moduleSelector.modulesAvailableForSelection());
   });
    stdin.listen((data) => socket.write(new String.fromCharCodes(data).trim() + '\n\r'));
}

void _dataHandler(Uint8List data)async{
  try{
    String requestText = ManipulateData.convertCharCodesToString(data);
    Map requestMap = ManipulateData.convertJsonToMap(requestText);

    if(requestMap.containsKey("id") && requestMap.containsKey("id") != "" && ManipulateData.checkStringIsInt(requestMap["id"])){
      int id = int.parse(requestMap["id"]);
      String parameter = requestMap["parameter"] ?? "";

      moduleSelector.mainSelector(id: id, parameter: parameter, socket: socket);

    }else{
      returnWarning("error in ID");
    }
  }catch(error){
    returnWarning("error processing data -> ${error.toString()}");
  }
}

void _errorHandler(dynamic errorObject, StackTrace stackError)
 => print("Error -> ${errorObject.toString}");

void _successfulHandler() => print("Finish Connect!");

void returnWarning(String text) => socket.write("WARNING: ${text}");
