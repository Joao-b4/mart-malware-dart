import 'dart:convert';

import '../lib/host.dart';
import '../lib/modules/modules.dart';
import '../lib/util/manipulate_data.dart';

Modules modules = Modules();
Host host = Host("localhost", 6662);

main(List<String> arguments) {
  tryConnect();
  host.listener = dataHandler;
}

tryConnect() {
  host.connect(initialConnection, (String e) {
    print("Unable to connect, ${e.toString()}");
    Future.delayed(const Duration(seconds: 3), tryConnect);
  });
}

initialConnection() {
  print("connected");
  host.sendMessage(
      "#" + ManipulateData.convertMapToJsonString(modules.getInfo()));
}

dataHandler(String text) async {
  try {
    var requestMap = ManipulateData.convertJsonToMap(text);
    var responseModule = await modules.selectorFromMap(requestMap);
    host.sendMessage(responseModule.toString());
  } catch (error) {
    print(error.toString());
    host.sendMessage("error in processing data, ${error.toString()}");
  }
}
